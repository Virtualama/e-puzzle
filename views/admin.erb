<!doctype html>
<style type="text/css">
  * {
    box-sizing: border-box;
  }

  html {
    font-family: arial
  }

  fieldset {
    width: 90%;
    display: inline-block;
    text-align: center;
    margin: 0;
    padding: 0;
  }

  .row {
    display: block;
    margin: 5px 0;
    padding: 0;
  }

  .title{
    font-size: xx-large;
  }

  input[type=file]{
    width: 0.1px;
    height: 0.1px;
    opacity: 0;
    overflow: hidden;
    position: absolute;
    z-index: -1;
  }

  input[type=file] + label,
  input[type=submit] {
    font-size: 1em;
    font-weight: 700;
    color: white;
    background-color: black;
    display: inline-block;
    padding: 5px;
    border-radius: 5px;
    cursor: pointer;
    border: 2px grey solid;
  }

  input[type=file]:focus + label,
  input[type=file] + label:hover,
  input[type=submit]:hover {
    opacity: 0.5;
  }

  input[type=file] + label {
    display: block;
    width: 90%;
    margin: 0 auto;
  }

  fieldset.options {
    width: 90%;
  }

  fieldset.options label{
    display: block;
  }

  input[type=checkbox]{
    vertical-align: middle;
  }

  select{
    visibility: hidden;
  }

  input[type=checkbox]:checked + select{
    visibility: visible;
  }

  input[type=text]{
    width: 90%
  }

  img.image_url {
    /*display: block;*/
    width: 300px;
    height: 300px;
    border: 1px black dotted;
  }

  img[src=""]{
    background-color: lightgrey;
  }

</style>

<div class="row">
  <fieldset>
    <form action="/api/pincodes/upload" method="post" enctype="multipart/form-data">
      <div class="row">
        <div class="title">Pincodes</div>
      </div>

      <div class="row">
        <span >Disponibles:</span>
        <span class="available"></span>
      </div>

      <div class="row">
        <input name="file" id="upload" type="file" accept=".csv">
        <label for="upload">Elige un Archivo</label>
      </div>

      <div class="row">
        <input type="submit" value="Añadir">
      </div>
    </form>
  </fieldset>
</div>

<div class="row">
  <fieldset class="options">
    <div class="row">
      <label>
        <span>
        URL para canjear pincodes (%{pincode} será reemplazado por cada código):
        </span>
        <br>
        <input class="url_template" type="text" placeholder="http://...">
      </label>
    </div>
    <div class="row">
      <label>
        <span>
        URL con la imagen a resolver (ha de ser cuadrada):
        </span>
        <br>
        <input class="image_url" type="text" placeholder="http://...">
        <div class="row">
          <img class="image_url">
          <div class="row">
            <input class="horizontal" type="number"> x
            <input class="vertical" type="number">
          </div>
        </div>
      </label>
    </div>
  </fieldset>
</div>

<script type="text/javascript" >
  var request = function(method, route, callback, body){
    var xhr = new XMLHttpRequest()
    xhr.open(method, route)
    xhr.responseType = 'json'
    xhr.addEventListener('load', function(event){
      if (callback)
        callback(event.target.response)
    })
    xhr.send(body)
  }

  var countPincodes = function(elementSelector){
    request('GET', '/api/pincodes/count/', function(response){
      document.querySelector(elementSelector).innerHTML = response.count
    })
  }

var showCurrentOptions = function(){
    var send = document.createElement('input')
    send.type = 'submit'
    send.value = 'Guardar'
    send.addEventListener('click', function(event){
      event.preventDefault()
      var formData = new FormData()

      var redemptionUrl = document.querySelector('input.url_template[type=text]').value
      formData.append('url_template', redemptionUrl)

      var imageUrl = document.querySelector('input.image_url[type=text]').value
      formData.append('image_url', imageUrl)

      var sizeHorizontal = document.querySelector('input.horizontal').value
      formData.append('size[horizontal]', sizeHorizontal)

      var sizeVertical = document.querySelector('input.vertical').value
      formData.append('size[vertical]', sizeVertical)

      request('PUT', '/api/sponsor/the_sponsor', function(response){
        console.log(response)
        document.location.reload()
      }, formData)
    })

    request('GET', '/api/sponsor/the_sponsor/selections', function(response){
      document.querySelector('input.url_template[type=text]').value = response.url_template
      document.querySelector('input.image_url[type=text]').value = response.image_url
      document.querySelector('img.image_url').src = response.image_url
      document.querySelector('input.horizontal').value = response.size.horizontal
      document.querySelector('input.vertical').value = response.size.vertical
    })

    document.querySelector('.options').appendChild(send)
  }

  document.addEventListener('DOMContentLoaded', function(){
    countPincodes('.available')

    showCurrentOptions()
  })
</script>
